<!DOCTYPE html >
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{index.html}">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Chỉnh sửa tòa nhà </title>
</head>
<body>
<div class="main-content" layout:fragment="content">
    <div class="main-content-inner">
        <div class="breadcrumbs" id="breadcrumbs">
            <script type="text/javascript">
                try {
                    ace.settings.check('breadcrumbs', 'fixed')
                } catch (e) {
                }
            </script>
            <ul class="breadcrumb">
                <li>
                    <i class="ace-icon fa fa-home home-icon"></i>
                    <a th:href="@{/home}">
                    Trang chủ
                    </a>
                </li>
                <li>
                    <a href="">
                        Quản lý tòa nhà
                    </a>
                </li>
                <li class="active">Chỉnh sửa người dùng</li>
            </ul><!-- /.breadcrumb -->
        </div>
        <div class="page-content">
            <div class="row">
                <div class="col-xs-12">
                    <div id="message" style="display: none">

                    </div>
                    <form  class="form-horizontal" role="form" id="formSubmit"  th:object="${buildingEdit}"  enctype="multipart/form-data">
                        <div class="form-group">
                            <label th:for="name" class="col-sm-3 control-label no-padding-right">Tên tòa nhà :</label>
                            <div class="col-sm-7">
                                <input type="text"  class="form-control" th:field ="*{name}" th:id="name" />
                            </div>

                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label no-padding-right" th:for="district"> Quận :</label>
                            <div class="col-sm-3" style="margin-bottom: 10px;">
                                <select th:field="*{district}">
                                    <option value=""> -- Chọn quận -- </option>
                                    <option th:each="entry : ${districts.entrySet()}"
                                            th:value="${entry.key}"
                                            th:utext="${entry.value}">
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="ward" >Phường :</label>
                            <div class="col-sm-7">
                                <input type="text"  class="form-control" th:field ="*{ward}" th:id="ward"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="street" >Đường :</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" th:field ="*{street}" th:id="street"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="structure" >Kết cấu :</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" th:field ="*{structure}" th:id="structure"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="numberOfBasement">Số tầng hầm :</label>
                            <div class="col-sm-7">
                                <input type="number"  th:id="numberOfBasement" class="form-control" name="numberOfBasement"  min ="0" th:field ="*{numberOfBasement}" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label no-padding-right" th:for="buildingArea" >Diện tích sàn : </label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" th:field ="*{buildingArea}" min="0" th:id="buildingArea"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="direction" >Hướng :</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" th:field ="*{direction}" th:id="direction"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="level" >Hạng :</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" th:field ="*{level}" th:id="level"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="rentArea">Diện tích thuê  :</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" th:field ="*{rentArea}" min="0" th:id="rentArea"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="descriptionArea">Mô tả diện tích  :</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" th:field ="*{descriptionArea}" th:id="descriptionArea"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="rentPrice">Giá thuê  :</label>
                            <div class="col-sm-7">
                                <input type="number"  th:id="rentPrice" class="form-control" name="rentPrice" th:field ="*{rentPrice}" min="0"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="rentPriceDescription">Mô tả giá  :</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" th:field ="*{rentPriceDescription}" th:id="rentPriceDescription"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="carCost">Phí ô tô  :</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" th:field ="*{carCost}" th:id="carCost"/>

                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="motorbikeCost">Phí mô tô  :</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" th:field ="*{motorbikeCost}" th:id="motorbikeCost"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="overtimeCost">Phí ngoài giờ  :</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" th:field ="*{overtimeCost}" th:id="overtimeCost"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="electricityCost">Tiền điện :</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" th:field ="*{electricityCost}" th:id="electricityCost"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="deposit">Đặt cọc  :</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" th:field ="*{deposit}" th:id="deposit"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="payment">Thanh toán  :</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" th:field ="*{payment}" th:id="payment"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="timeRent">Thời hạn thuê :</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" th:field ="*{timeRent}" min="0" th:id="timeRent"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="timeDecorator">Thời gian trang trí :</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" th:field ="*{timeDecorator}" th:id="timeDecorator"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="managerName" >Tên quản lý :</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" th:field ="*{managerName}" th:id="managerName"/>

                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="managerPhone" >SĐT quản lý :</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" th:field ="*{managerPhone}" th:id="managerPhone"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="brokerageFee" >Phí mô giới :</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" th:field ="*{brokerageFee}" th:id="brokerageFee"/>
                            </div>
                        </div>

                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" > Loại tòa nhà :</label>
                            <div class="col-sm-7">
                                <li th:each="type : ${buildingTypes}" >
                                    <input type="checkbox"
                                           th:field="*{buildingTypes}"
                                           th:value="${type.getValue()}" />
                                    <label th:text="${type.getValue()}"></label>
                                </li>
                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right" th:for="note" >Ghi chú :</label>
                            <div class="col-sm-7">
                                <textarea id="note" name="note" rows="4" cols="99" ></textarea>

                            </div>
                        </div>
                        <div class="form-group">
                            <label  class="col-sm-3 control-label no-padding-right"  th:for="thumbnail" >Ảnh đại diện</label>
                            <div class="col-sm-4">
                                <input style="margin-top: 6px;" type="file"  th:field ="*{thumbnail}" th:value="${buildingEdit.thumbnail}" accept="image/png, image/jpeg, image/jpg" placeholder="thumbnail">
                            </div>
                            <div class="col-sm-5">
                                <img th:src="${(buildingEdit.thumbnail != null && !#strings.isEmpty(buildingEdit.thumbnail)) ? '/img/'+buildingEdit.thumbnail : '/img/noimages.jpg'}"
                                     id="fileImage"  alt="Ảnh đại diện" style="width: 300px; height: 400px;" />
                            </div>

                        </div>
                        <input type="hidden"  id="buildlingId" th:field ="*{id}" th:value="${id}"/>
                        <div class="clearfix form-actions">
                            <div class="col-md-offset-3 col-md-9" >
                                  <div th:if="${buildingEdit.id != null}" >
                                      <button class="btn btn-info" type="button"  id="btnUpdateBuilding" >
                                          <i class="ace-icon fa fa-check bigger-110"></i>
                                          Cập nhật tòa nhà
                                      </button>
                                  </div>

                                <div th:if="${buildingEdit.id == null}" >
                                    <button class="btn btn-info" type="button"  id="btnAddBuilding"  >
                                        <i class="ace-icon fa fa-check bigger-110"></i>
                                        Thêm tòa nhà
                                    </button>
                                </div>
                                <button class="btn" type="reset" style="    margin-left: 200px;   margin-top: -64px;">
                                    <i class="ace-icon fa fa-undo bigger-110"></i>
                                    Hủy
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<th:block layout:fragment="script" th:inline="javascript">
<script>
    /* validate */
    jQuery.extend(jQuery.validator.messages, {
        required: "Không được bỏ trống trường này.",
        remote: "Please fix this field.",
        email: "Please enter a valid email address.",
        url: "Please enter a valid URL.",
        date: "Please enter a valid date.",
        dateISO: "Please enter a valid date (ISO).",
        number: "Vui lòng nhập số vào trường này.",
        digits: "Vui lòng nhập số nguyên vào trường này.",
        equalTo: "Please enter the same value again.",
        accept: "Please enter a value with a valid extension.",
        maxlength: jQuery.validator.format("Please enter no more than {0} characters."),
        minlength: jQuery.validator.format("Please enter at least {0} characters."),
        range: jQuery.validator.format("Please enter a value between {0} and {1}."),
        max: jQuery.validator.format("Please enter a value less than or equal to {0}."),
        min: jQuery.validator.format("Vui lòng nhập giá trị lớn hơn giá trị {0} .")
    });

    $('#formSubmit').validate({
        rules:{
            name : "required",
            ward :"required",
            street : "required",
            district :"required",
            numberOfBasement : {
                required: true,
                digits: true ,
                min: true
            },
            buildingArea :  {
                required: true,
                number: true ,
                min: true
            },
            rentArea :"required",
            rentPrice : {
                required: true,
                number: true ,
                min: true
            },
            buildingTypes :{
                required: true,
                minlength: 1
            }


        },
        messages: {
            name : "Vui lòng nhập tên của tòa nhà.",
            ward :"Vui lòng nhập địa chỉ phường của tòa nhà. ",
            street : "Vui lòng nhập địa chỉ đường của tòa nhà. ",
            district :"Vui lòng nhập quận của tòa nhà.",
            numberOfBasement : {
                required: "Vui lòng nhập số tầng hầm của tòa nhà.",
                digits: "Vui lòng nhập số nguyên vào trường này." ,
                min: "Vui lòng nhập giá trị lớn hơn giá trị lớn hơn hoặc bằng 0 ."
            },
            buildingArea :  {
                required: "Vui lòng nhập diện tích của tòa nhà.",
                number: "Vui lòng nhập số vào trường này." ,
                min: "Vui lòng nhập giá trị lớn hơn giá trị lớn hơn hoặc bằng 0 ."
            },
            rentArea :"Vui lòng nhập diện tích thuê của tòa nhà.",
            rentPrice : {
                required: "Vui lòng nhập giá thuê của tòa nhà.",
                number: "Vui lòng nhập số vào trường này.",
                min: "Vui lòng nhập giá trị lớn hơn giá trị lớn hơn hoặc bằng 0 ."
            },
            buildingTypes :{
                required: "Vui lòng lựa chọn loại của tòa nhà.",
                minlength: 1
            }
        }

    })






    let oldFileNameBuilding = [[${buildingEdit.thumbnail}]];

    function dataBuilding(){
        let data = {};
        let buildingTypes =[];
        let formData = $('#formSubmit').serializeArray();
        $.each(formData, function (i,v){
            if (v.name == 'buildingTypes'){
                buildingTypes.push(v.value);
            }else {
                data[""+v.name+""] = v.value;
            }
        })
        if(fileName == null ){
            if (oldFileNameBuilding != null){
                data['thumbnail'] = oldFileNameBuilding;
            }else{
                data['thumbnail'] = null;
            }
        }else{
            data['thumbnail'] = fileName;
        }
        data['buildingTypes'] = buildingTypes;
        return data;
    }


    /* Add building */
    $('#btnAddBuilding').click(function () {
        warningBeforeAdd();
    })

    function warningBeforeAdd(){
        showAlertBeforeAdd(function (){
            event.preventDefault();
            if ($('#formSubmit').valid()){
                let dataAdd = dataBuilding();
                addBuilding(dataAdd);
            }
        })
    }

    function  addBuilding(data){
        $.ajax({
            url : '/api/building',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            dataType: 'json',
            success: function () {
                swal("Saved!", "success").then((result) => {
                    if(result.value){
                        location.reload();
                        window.location.href = "/building-edit"
                    }
                });
            },
            error: function () {
                swal("Error", "Could not be saved! :)", "error");
            }
        });
    }

    /* update building */

    $('#btnUpdateBuilding').click(function () {
       warningBeforeUpdate();
    })

    function warningBeforeUpdate(){
        showAlertBeforeUpdate(function (){
            event.preventDefault();
            if ($('#formSubmit').valid()) {
                let dataEdit = dataBuilding();
                let idOfBuilding = $('#buildlingId').val();
                dataEdit['id'] = idOfBuilding;
                updateBuilding(dataEdit);
            }
        })
    }

    function  updateBuilding(data){
        $.ajax({
            url : '/api/building',
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            dataType: 'json',
            success: function (res) {
                swal("Updated!", "success").then((result) => {
                    if(result.value){
                        location.reload();
                        window.location.href = "/building-edit-"+res.id;
                    }
                });
            },
            error: function (res) {
                swal("Error", "Could not be updated! :)", "error");
                window.location.href = "/building-edit-"+res.id;
            }
        });
    }


</script>
</th:block>
</body>
</html>